#!/bin/sh
set -e

DEV=$1
MODE=$2
DIR=$3

oldIFS="$IFS"
IFS='/'
# Store the last element in CH_NAME and the next-to-last element in MDEV
for path_elem in $DEV; do
	MDEV=$CH_NAME
	CH_NAME=$path_elem
done
IFS="$oldIFS"

AIMS=/sys/devices/virtual/most/mostcore/aims

sleep 0.1

case "$MODE" in
	control)	
		# We can't use udev ATTR{}="..." to set these attributes, since the driver
		# _requires_ the trailing newline generated by echo...
		echo control > "$DEV/set_datatype"
		echo "dir_$DIR" > "$DEV/set_direction"
		echo 32 > "$DEV/set_number_of_buffers"
		echo 128 > "$DEV/set_buffer_size"

		echo "$MDEV:$CH_NAME:inic-ctrl-$DIR" > "$AIMS/cdev/add_link"
		;;
	async)
		# We can't use udev ATTR{}="..." to set these attributes, since the driver
		# _requires_ the trailing newline generated by echo...
		echo async > "$DEV/set_datatype"
		echo "dir_$DIR" > "$DEV/set_direction"
		echo 32 > "$DEV/set_number_of_buffers"
		echo 1548 > "$DEV/set_buffer_size"

		echo "$MDEV:$CH_NAME:" > "$AIMS/networking/add_link"
		echo "$MDEV:$CH_NAME:inic-async-$DIR" > "$AIMS/cdev/add_link"
		;;
	*)
		echo "Invalid mode $MODE"
		exit 1
		;;
esac
